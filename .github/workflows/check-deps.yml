name: Check Dependencies For Updates

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0" # Check every Sunday at midnight

jobs:
  check:
    runs-on: ubuntu-slim
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.MERCURY_BOT_APP_ID }}
          private-key: ${{ secrets.MERCURY_BOT_KEY }}

      - uses: actions/checkout@v5

      - name: Set User
        run: |
          git config user.name "Mercury Actions Bot"
          git config user.email "mercury-actions-bot[bot]@users.noreply.github.com"

      - name: Cleanup Existing Auto-Update Branches & PRs
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "Looking for existing auto-deps-update branches..."

          # Get all matching remote branches
          BRANCHES=$(git ls-remote --heads origin "refs/heads/auto-deps-update-*" | awk '{print $2}' | sed 's|refs/heads/||')

          if [ -z "$BRANCHES" ]; then
            echo "No existing update branches found."
            exit 0
          fi

          echo "Found branches:"
          echo "$BRANCHES"

          # Close related PRs
          for BR in $BRANCHES; do
            echo "Processing branch: $BR"

            # Look for open PRs associated with this branch
            PR_NUM=$(gh pr list \
              --state open \
              --head "$BR" \
              --json number \
              --jq '.[0].number // empty')

            if [ -n "$PR_NUM" ]; then
              echo "Closing PR #$PR_NUM associated with $BR"
              gh pr close "$PR_NUM" --delete-branch || true
            else
              echo "No open PR for $BR â€” deleting branch manually."
              git push origin --delete "$BR" || true
            fi
          done

      - name: Check & Update Library Deps List
        id: version
        run: |
          DEPS_CHANGED=$(./build_tools/check_deps_updates.sh | tail -1)
          echo "deps_changed=$DEPS_CHANGED" >> $GITHUB_OUTPUT

      - name: Create Library Deps Update Branch
        if: ${{ steps.version.outputs.deps_changed != 'None' }}
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Create branch & commit
          git checkout -b auto-deps-update-${{ github.run_id }}
          git add build_tools/dependencies.txt
          git commit -m "Automatic update of dependencies.txt" || echo "No changes to commit"
          git push origin HEAD

      - name: Create PR
        if: ${{ steps.version.outputs.deps_changed != 'None' }}
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          PR_BODY=$( echo -e "Automated dependencies bump for ${{ steps.version.outputs.deps_changed }}.\n\n**NOTE**: Manual CHANGELOG.md and version.txt updates are required." )

          gh pr create \
            --title "[Deps.] Automated Deps. Bump: ${{ steps.version.outputs.deps_changed }}" \
            --body "$PR_BODY" \
            --base main \
            --assignee "travis-heavener" \
            --head auto-deps-update-${{ github.run_id }} \
            --label "feature,repo,top-priority"