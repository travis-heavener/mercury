name: Test Runner (Windows)

on:
    workflow_dispatch:
    push:
        branches: ["main"]
        paths:
            - "src/**"
            - "lib/**"
    pull_request:
        branches: ["main"]
        paths:
            - "src/**"
            - "lib/**"

jobs:
    Build:
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v4

            # Make log files
            - name: Make Log Files
              run: mkdir logs

            # Start Mercury
            - name: Start Mercury
              run: |
                cd bin
                powershell -command 'Start-Process .\mercury.exe -NoNewWindow -PassThru | ForEach-Object { $_.Id } > ..\pid.txt'

            # Run Python test cases
            - name: Python Test Runner
              run: |
                python --version || choco install python
                cd tests
                $output = python run.py
                echo $output
                if ($output.Split("`n")[-2] -like "*Failure*") {
                  $mercury_pid = Get-Content ..\pid.txt
                  Stop-Process -Id $mercury_pid -Force
                  Start-Sleep -Seconds 5
                  exit 1
                }

            # Kill the server
            - name: Kill Server
              run: |
                $mercury_pid = Get-Content pid.txt
                Stop-Process -Id $mercury_pid -Force
                Start-Sleep -Seconds 5