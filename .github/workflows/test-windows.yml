name: Test Runner (Windows)

on:
  workflow_call:
    inputs:
      artifact-name:
        required: true
        type: string

jobs:
  Test-Windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v5

      # Download binaries
      - name: Cache Windows Binaries
        uses: actions/cache@v4
        with:
          path: ./bin/mercury.exe
          key: mercury-windows-binaries-${{ github.sha }}
          enableCrossOsArchive: true

      - name: Copy Default Config
        run: |
          Copy-Item ./conf/default/mimes.conf ./conf/mimes.conf
          Copy-Item ./conf/default/mercury.conf ./conf/mercury.conf

      - name: Install Python Deps
        run: python -m pip install brotli zstandard psutil

      - name: Setup PHP
        run: ./conf/setup_php.ps1

      # Make TLS cert
      - name: Make TLS Cert
        run: |
          openssl req -x509 -newkey rsa:4096 -keyout conf/ssl/key.pem -out conf/ssl/cert.pem -sha256 -days 1 -nodes -subj "/C=XX/ST=New York/L=NYC/O=The Mercury Project/OU=GitHub Action Runner/CN=The Mercury Developers"

      # Run Python test cases
      - name: Python Test Runner
        run: |
          python tests/run.py
