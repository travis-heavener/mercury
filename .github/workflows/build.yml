name: Build & Test

on:
  workflow_dispatch:
  workflow_call:
  push:
    branches: ["main"]
    paths:
      - "src/**"
      - "lib/**"
  pull_request:
    branches: ["main"]
    paths:
      - "src/**"
      - "lib/**"

jobs:
  Build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      # Cache build outputs by commit hash
      - name: Cache Linux Binaries (Overwritten by Make -B Don't Worry)
        uses: actions/cache@v4
        with:
          path: ./bin/mercury
          key: mercury-linux-binaries-${{ github.sha }}

      - name: Cache Windows Binaries (Overwritten by Make -B Don't Worry)
        uses: actions/cache@v4
        with:
          path: ./bin/mercury.exe
          key: mercury-windows-binaries-${{ github.sha }}
          enableCrossOsArchive: true

      # Mark artifacts for caching
      - name: Cache Library Artifacts
        uses: actions/cache@v4
        with:
          path: ./libs
          key: ${{ runner.os }}-artifacts-${{ hashFiles('**/build_tools/build_lib_brotli.sh', '**/build_tools/build_lib_openssl.sh', '**/build_tools/fetch_lib_pugixml.sh', '**/build_tools/build_lib_zstd.sh') }}

      # Make executables
      - name: Make Executable Shell Scripts
        run: sudo chmod +x ./build_tools/*.sh

      # Install & cache APT deps
      - name: Install APT Deps
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: build-essential nasm zlib1g-dev php-cgi
          version: 1.0

      # Install deps & build static binaries
      - name: Build Libs
        run: |
          # Run w/o make (not installed yet)
          sudo ./build_tools/install_workflow_deps.sh

          if [ ! -d libs ] || [ -z "$(ls -A libs)" ]; then
            make lib_brotli
            make lib_openssl
            make lib_pugixml
            make lib_zstd
          fi

          # Build static zlib anyways (can't cache, takes < 10 sec)
          make lib_zlib

      # Build
      - name: Build Mercury Binaries
        run: |
          sudo make -B

  Run-Linux-Tests:
    needs: Build
    uses: ./.github/workflows/test-linux.yml
    with:
      artifact-name: mercury-binaries

  Run-Windows-Tests:
    needs: Build
    uses: ./.github/workflows/test-windows.yml
    with:
      artifact-name: mercury-binaries
