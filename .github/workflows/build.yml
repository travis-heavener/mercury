name: Build

on:
    workflow_dispatch:
    push:
        branches: ["main"]
        paths:
            - "src/**"
            - "lib/**"
    pull_request:
        branches: ["main"]
        paths:
            - "src/**"
            - "lib/**"

jobs:
    Build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Cache APT packages
              uses: actions/cache@v4
              with:
                path: ./static_libs
                key: ${{ runner.os }}-libs-linux-${{ hashFiles('**/build_tools/install_deps.sh') }}

            # Make executables
            - name: Make Executable Shell Ccripts
              run: sudo chmod +x ./build_tools/*.sh

            # Install deps & build static binaries
            - name: Install Deps & Build Libs
              run: |
                if [ ! -d static_libs ] || [ -z "$(ls -A static_libs)" ]; then
                  make libs
                fi

            # Build
            - name: Build Mercury Binaries
              run: sudo make -B