name: Build & Test

on:
  workflow_dispatch:
  workflow_call:
  push:
    branches: ["main"]
    paths:
      - "src/**"
      - "lib/**"
  pull_request:
    branches: ["main"]
    paths:
      - "src/**"
      - "lib/**"

jobs:
  Build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      # Mark artifacts for caching
      - name: Cache Library Artifacts
        uses: actions/cache@v4
        with:
          path: ./libs
          key: ${{ runner.os }}-artifacts-${{ hashFiles('**/build_tools/build_lib_brotli.sh', '**/build_tools/build_lib_openssl.sh', '**/build_tools/fetch_lib_pugixml.sh', '**/build_tools/build_lib_zstd.sh') }}

      # Make executables
      - name: Make Executable Shell Scripts
        run: sudo chmod +x ./build_tools/*.sh

      # Install & cache APT deps
      - name: Install APT Deps
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: build-essential mingw-w64 nasm zlib1g-dev php-cgi
          version: 1.0

      # Install deps & build static binaries
      - name: Build Libs
        run: |
          if [ ! -d libs ] || [ -z "$(ls -A libs)" ]; then
            make lib_brotli
            make lib_openssl
            make lib_pugixml
            make lib_zstd
          fi

          # Build static zlib anyways (can't cache, takes < 10 sec)
          make lib_zlib

      # Build
      - name: Build Mercury Binaries
        run: sudo make -B

      # Upload build artifacts
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mercury-binaries
          path: ./bin

      # Upload static libs
      - name: Upload Static Libraries for workflow_call
        uses: actions/upload-artifact@v4
        with:
          name: static-libs
          path: ./libs

  Run-Linux-Tests:
    needs: Build
    uses: ./.github/workflows/test-linux.yml
    with:
      artifact-name: mercury-binaries

  Run-Windows-Tests:
    needs: Build
    uses: ./.github/workflows/test-windows.yml
    with:
      artifact-name: mercury-binaries
